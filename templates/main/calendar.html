<!-- GroupCal/templates/main/calendar.html -->
{% extends 'base.html' %}
{% load get_dict_item %}
{% load static %}
{% block script %}

    {#    <script src="{% static 'static_root/main/js/main.js' %}">#}
    <script>
        /** to do:
         * fix event update
         * delete users fro groups
         * permissions
         * see event ?
         * delete events
         **/

        document.addEventListener('DOMContentLoaded', function()
        {
            function get_calendar_height() {
                return $(window).height()-30;
            }
            let add_to_in_charge_msg = document.getElementById("success-alert");
            let current_event = null;
            let calendarEl = document.getElementById('calendar');
            let calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [ 'interaction', 'dayGrid', 'timeGrid' ],
                defaultView: 'dayGridMonth',
                editable: true,
                selectable: true,
                height: get_calendar_height(),
                customButtons: {
                    mySideNav: {
                        className: 'button-collapse black-text',
                        click: function() {
                            $('#fluidModalSuccess').modal('show')
                        }
                    }
                },
                headerToolbar: {
                    left: 'mySideNav prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay',
                },
                eventSources: [],
                windowResize:  function(view) {
                    calendar.setOption('height', get_calendar_height());
                },

                dateClick: function(info) {

                    console.log(Object.values(events_sources));
                    console.log(calendar.refetchEvents());
                    $('#createEventModal').modal('show');
                    $('#id_take_on_event').click(function () {
                        $("#id_charge_num").attr('disabled', !this.checked)
                    });
                    $('#eventForm').submit(function (e) {
                        e.preventDefault();
                        let title=$('#id_title').val();
                        let description=$('#id_description').val();
                        let date = info.dateStr;
                        let to_do = $('#id_take_on_event').val();
                        let charge_num = $('#id_charge_num').val();
                        $.ajax({
                            type: 'POST',
                            url: '{%  url "main:calendar" user.pk %}',
                            data: {
                                title: title,
                                description: description,
                                current_group: $('#id_group').val(),
                                start_hour: $('#id_start_hour').val(),
                                end_hour: $('#id_end_hour').val(),
                                date: date,
                                to_do: to_do,
                                charge_num: charge_num,
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                            },
                            success: function (response) {
                                /** event has created
                                 * hide the form window
                                 * add the event to the calendar
                                 ***/
                                $('#createEventModal').modal('hide');
                                let new_event = {
                                    id: response.instance_id,
                                    title: title,
                                    description: description,
                                    start: response.start_time,
                                    end: response.end_time,
                                    extendedProps: {
                                        to_do: to_do,
                                        charge_num: charge_num,
                                    },
                                };
                            },
                            error: function (rs, e) {
                                console.log(rs.responseText);
                            }
                        });
                    });
                },
                eventClick: function(info) {
                    /**event window is open so user can:
                     * add them self to users in charge list
                     * update the event (if they created it -- verify in update_event_window(info))
                     **/
                    info.jsEvent.preventDefault();
                    current_event = info;
                    /*** fetch the event data from the server and display the info according to it type (to do or not to do)
                     * check if someone need to do the event:
                     *  info.event.extendedProps.to_do === 'False':
                     *  dont show the list of users that in charge to do the event
                     *
                     * info.event.extendedProps.to_do === 'True':
                     * send the event id to the server
                     * get the users list that in charge to do the event from the serer
                     * show the list in event window
                     *
                     ***/
                    if (info.event.extendedProps.to_do === 'False') {
                        clear_event_data();
                        update_event_window(info);
                    } else {
                        fetch(`http://127.0.0.1:8000/event-detail/${info.event.id}/`, {
                            method: 'GET',
                            headers: {
                                'Content-type': 'application/json',
                            },
                        }).then(response => response.json())
                            .then(data => {
                                console.log(data);
                                show_in_charge_users(data.charge_users);
                                clear_event_data();
                                update_event_window(info);
                                document.getElementById("eventToDoBtn").addEventListener("click", function () {
                                    /** event is a to do event and user want to add himself to
                                     * the list of users that in charge -->> check with the server:
                                     * that the user is not in the list
                                     * the list is not full
                                     * the event is a to do event (just in case)
                                     **/
                                    fetch(`http://127.0.0.1:8000/event-update-users/${info.event.id}/`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-type': 'application/json',
                                            'X-CSRFToken':'{{ csrf_token }}',
                                        },
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            console.log(data);
                                            switch (data) {
                                                case 0:
                                                    let ul = document.getElementById("eventChargeUsers");
                                                    let li = document.createElement('li');
                                                    li.className = "list-group-item";
                                                    li.appendChild(document.createTextNode('{{ user }}'));
                                                    ul.appendChild(li);
                                                    break;
                                                case 1:
                                                    add_to_in_charge_msg.innerHTML = 'you already in this list';
                                                    add_to_in_charge_msg.style.display = 'block';
                                                    break;
                                                case 2:
                                                    add_to_in_charge_msg.innerHTML = 'this list is full';
                                                    add_to_in_charge_msg.style.display = 'block';
                                                    break;
                                            }
                                        });
                                });
                            });
                    }
                },
                eventDrop: function (info) {
                    $.ajax({
                        type: 'GET',
                        url: '{%  url "events:ajax_event_change_date" %}',
                        data: {
                            event_id: info.event.id,
                            new_date_start: info.event.start.toISOString(),
                            new_date_end: info.event.end.toISOString(),
                        },
                        success: function(response) {
                            console.log(response)

                        },
                        error : function(xhr,errmsg,err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        },
                    });
                },
            });

            calendar.render();
            function get_event_from_source(group_id) {
                console.log(group_id)
                calendar.addEventSource({
                    id: group_id,
                    events: function (info, successCallback, failureCallback) {
                        var url = `http://127.0.0.1:8000/update-event-source/${group_id}/`;
                        fetch(url, {
                            method: 'GET',
                            headers: {
                                'Content-type': 'application/json',
                            },
                        }).then(response => response.json())
                            .then(data => {
                                var events = [];
                                console.log(data.group_events);
                                $(data.group_events).each(function () {
                                    events.push({
                                        title: $(this).attr('title'),
                                        start: $(this).attr('start'),
                                        end: $(this).attr('end'),
                                        id: $(this).attr('id'),
                                        description: $(this).attr('description'),
                                        color: $(this).attr('color'),
                                        textColor: 'black',
                                        charge_num: $(this).attr('charge_num'),
                                        to_do: $(this).attr('to_do'),
                                        user_id: $(this).attr('to_do'),

                                    })
                                });
                                successCallback(events);
                                console.log(calendar.getEventSources())
                            })
                    },

                });
                calendar.refetchEvents()
            }


            var groups = document.getElementsByClassName("filterEventsByGroup");
            for(let i=0;i < groups.length; i++)
            {
                groups[i].addEventListener("change", function() {
                    console.log(parseInt(this.value[0]))
                    if (this.checked === true) {
                        get_event_from_source(parseInt(this.value[0]), this.value[1]);
                    }
                    else {
                        calendar.getEventSourceById(parseInt(this.value[0])).remove();

                    }
                });
            }


            function update_event_window(info){
                console.log(info.event.title)
                document.getElementsByClassName("eventTitle").innerHTML = info.event.title;
                document.getElementById("eventDescription").innerHTML = info.event.extendedProps.description.toString();
                document.getElementById("eventStart").innerHTML = info.event.start;
                document.getElementById("eventEnd").innerHTML = info.event.end;
                document.getElementById("eventToDoBtn").disabled = info.event.extendedProps.to_do === "False";
                console.log('{{ user.pk }}');
                console.log(info.event.extendedProps.user_id);
                if('{{ user.pk }}' === info.event.extendedProps.user_id){
                    document.getElementById('UpdateEventBtn').style.display ='inline';
                    document.getElementById('UpdateEventBtn').addEventListener("click", function () {
                        $('#eventDetails').modal('hide');
                        update_event_form(info);
                    });
                }
                else{
                    document.getElementById('UpdateEventBtn').style.display ='none';
                }
                $('#eventDetails').modal('show');
            }

            function show_in_charge_users(users_list) {
                $("#eventToDoBtn").disabled = false;
                let ul = document.getElementById("eventChargeUsers");
                for (let i = 0; i < users_list.length; i++){
                    let name = users_list[i];
                    console.log(name);
                    let li = document.createElement('li');
                    li.className ="list-group-item";
                    li.appendChild(document.createTextNode(name));
                    ul.appendChild(li);
                }
            }

            function update_event_form(info){
                console.log(info);
                document.getElementById("id_title").value = info.event.title;
                document.getElementById("id_description").value = info.event.extendedProps.description.toString();
                document.getElementById("id_take_on_event").checked = info.event.extendedProps.to_do;
                document.getElementById("id_charge_num").value = info.event.extendedProps.charge_num;
                document.getElementById("id_charge_num").value = info.event.extendedProps.charge_num;
                // document.getElementById("id_start_hour").op = ;
                // document.getElementById("id_end_hour").value = ;
                $('#createEventModal').modal('show');
            }
            function clear_event_data() {
                document.getElementById("eventTitle").innerHTML = '';
                document.getElementById("eventDescription").innerHTML = '';
                document.getElementById("eventStart").innerHTML = '';
                document.getElementById("eventEnd").innerHTML = '';
                $('#eventChargeUsers').empty();
                add_to_in_charge_msg.innerHTML = '';
                add_to_in_charge_msg.style.display = 'none';
            }

            function open_users_manager_window() {
                $('#manageUsersWindow').modal('show');
                let user_pk = 1;
                document.getElementById('DeleteUsersBtn').addEventListener('click', function () {
                    var url = `http://127.0.0.1:8000/event-detail/${user_pk}/`;
                    fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                    }).then(response => response.json())
                        .then(data => {
                            console.log(data.id);
                        }).catch(function (error) {
                        console.log('ERROR:', error)
                    });

                });
            }

            const user_input = $("#user-input");
            const search_icon = $('#search-icon');
            const users_div = $('#replaceable-content');
            const endpoint = '/search-users-view/';
            const delay_by_in_ms = 700;
            let scheduled_function = false;

            let ajax_call = function (endpoint, request_parameters) {
                $.getJSON(endpoint, request_parameters)
                    .done(response => {
                        // fade out the artists_div, then:
                        users_div.fadeTo('slow', 0).promise().then(() => {
                            // replace the HTML contents
                            users_div.html(response['html_from_view']);
                            // fade-in the div with new contents
                            users_div.fadeTo('slow', 1);
                            document.getElementById('sendFriendRequest').addEventListener('click', function () {
                                var data = {'receiver_id':this.value,};
                                fetch('http://127.0.0.1:8000/api/send-friend-request/', {
                                    method: 'POST',
                                    headers: {
                                        'Accept': 'application/json, text/plain, */*',
                                        'Content-type': 'application/json',
                                        'X-CSRFToken':'{{ csrf_token }}',
                                    },
                                    body: JSON.stringify(data)
                                }).then(response => response.json())
                                    .then(data => {
                                        console.log(data);
                                        // return massege to user -->> to do
                                    }).catch(function (error) {
                                    console.log('ERROR:', error)
                                });
                            })
                            // stop animating search icon
                            // search_icon.removeClass('blink')
                        })
                    })
            };
            user_input.on('keyup', function () {
                const request_parameters = {
                    q: $(this).val() // value of user_input: the HTML element with ID user-input
                };
                // if scheduled_function is NOT false, cancel the execution of the function
                if (scheduled_function) {
                    clearTimeout(scheduled_function)
                }
                scheduled_function = setTimeout(ajax_call, delay_by_in_ms, endpoint, request_parameters)
            });

        });

        function response_to_friend_request(e, response) {
            var data = {
                'response': response,
            };
            fetch(`http://127.0.0.1:8000/api/response-to-friend-request/${e.value}/`, {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken':'{{ csrf_token }}',
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
                .then(data =>
                {
                    console.log(data);
                    e.innerHTML = '<i class="fas fa-check-circle"></i>';
                    var elem = e.parentNode;
                    var elem_btns = elem.getElementsByTagName('button');
                    console.log(elem_btns);

                }).catch(function (error) {
                console.log('ERROR:', error)
            });
        }

    </script>
{% endblock %}

{% block content %}
    <div class="container-fluid p-2">
        <div class="row p-3">
            <div class="col" id='calendar'></div>
            <div class="col-4 col-md-2 border sidebar" style="background-color: rgba(32,80,103,0.34)">
                <h3 class="sidebar-title">hey {{ request.user.username }}</h3>
                <ul class="list-group list-group-flush fa-ul ml-3 my-5 list-unstyled menu-headers">
                    <!-- Side navigation links -->
                    <li><i class="fas fa-user-friends fa-sm"></i><a class="collapsible p-2"  data-toggle="collapse" data-target="#collapseUsers"
                                                                    aria-expanded="false" aria-controls="collapseUsers">see users in groups</a>
                        <i class="fas fa-angle-down rotate-icon"></i>
                        <div class="collapse" id="collapseUsers">
                            {% for group in users_in_groups %}
                                {{ group.group_name }}
                                <ul class="list-group list-unstyled">
                                    {% for user in group.users %}
                                        <li><a href="#" class="waves-effect">
                                            {{ user.user_name }}</a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endfor %}
                        </div>
                    </li>

                    <li><i class="fas fa-layer-group fa-sm"></i> <a class="collapsible p-2"  data-toggle="collapse" data-target="#collapseGroups"
                                                                    aria-expanded="false" aria-controls="collapseGroups">your groups</a>
                        <i class="fas fa-angle-down rotate-icon"></i>
                        <div class="collapse" id="collapseGroups">
                            <ul class="list-group mr-auto list-unstyled">
                                {% for group in user_groups %}
                                    <li>  <input type="checkbox" class="form-check-input filterEventsByGroup" id="groupCheckBox" value="{{ group.id }}">
                                        <label class="form-check-label" for="groupCheckBox"> {{ group.name }}</label> </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </li>
                    <li><i class="fas fa-filter fa-sm"></i><a class="collapsible p-2"  data-toggle="collapse" data-target="#collapseOptions"
                                                              aria-expanded="false" aria-controls="collapseOptions"> more options</a>
                        <i class="fas fa-angle-down rotate-icon"></i>
                        <div class="collapse" id="collapseOptions">
                            <ul class="list-group list-unstyled">
                                <li><a href="#" class="waves-effect">See your event</a></li>
                                <li><a href="{% url 'accounts:create-group' %}" class="waves-effect">create new group</a></li>
                                <li><a type="button" class="btn btn-primary" data-toggle="modal" data-target="#addContactsForm">add contacts</a></li>
                                <li><a href="{% url 'account_logout' %}" class="waves-effect">logout</a></li>
                                <li><a type="button" class="btn btn-primary" data-toggle="modal" data-target="#friendsRequest">friends request</a></li>
                            </ul>
                        </div>
                    </li>
                    <!--/. Side navigation links -->
                </ul>
            </div>
        </div>

    </div>

    <!-- Manage users PopUp -->
    <div class="modal fade" id="manageUsersWindow" tabindex="-1" role="dialog" aria-labelledby="manegeUsersModal"
         aria-hidden="true">
        <div class="modal-dialog modal-m " role="document">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title w-100 font-weight-bold text-center" id="manageUsers"></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex flex-column" id="eventContent">
                    {% for user in users_in_group %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="{{ user.id }}">
                            <label class="form-check-label" for="{{ user.id }}">{{ user.username }}</label>
                        </div>
                    {% endfor %}
                    <button type="button" class="btn btn-secondary btn-sm" id="DeleteUsersBtn">Delete users</button>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeEventWindow'">Close</button>
                    <button type="button" class="btn btn-primary" id="addUsersToGroup">add users</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Manage users PopUp -->


    <!-- Event Detail PopUp -->
    <div class="modal fade" id="eventDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-m " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <p class="modal-title w-100 font-weight-bold text-center" id="eventTitle"></p>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex flex-column" id="eventContent">
                    <p class="text-center" id="eventDescription"></p>
                    <span>start at:<p class="text-center" id="eventStart"></p></span>
                    <span>end at:<p class="text-center" id="eventEnd"></p></span>
                    <div class="alert alert-success" id="success-alert" style="display:none">
                        <button type="button" class="close" >x</button>
                        <span class="glyphicon glyphicon-ok"></span>
                    </div>
                    <ul class="list-group list-group-flush" id="eventChargeUsers" title="How is doing?">How is doing?</ul>
                </div>
                <div class="modal-footer justify-content-center">
                    <button id="eventToDoBtn" type="button" class="btn btn-blue-grey">Do it</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeEventWindow'">Close</button>
                    <button type="button" class="btn btn-primary" id="UpdateEventBtn">Update Event</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Event Detail PopUp -->


    <!-- Create Event Form -->
    <div class="modal fade" id="createEventModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Add Event</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" id="eventForm" action="">
                    <div class="modal-body mx-3">
                        {% csrf_token %}
                        {{ form.as_p }}
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="submit" id="submitButton" class="btn btn-unique">Save<i class="fas fa-paper-plane-o ml-1"></i></button>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Create Event Form -->


    <!-- Add Contacts Form -->
    <div class="modal fade" id="addContactsForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">Search users by email</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="col-4 col-md-6">
                        <span><i id="search-icon" class="fas fa-search"></i><input id="user-input" placeholder="Search"></span>
                    </div>

                    <div id="replaceable-content" class="col" style="background-color: #f53148">
                        {% include 'account/users_search_result.html' %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Contacts Form  -->

    <!-- Add Contacts Form -->
    <div class="modal fade" id="friendsRequest" tabindex="-1" role="dialog" aria-labelledby="friendsRequestPopUp"
         aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">your friends request</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% if user_friends_request %}
                        <ul class="list-group list-unstyled mx-2">
                        {% for f_request in user_friends_request %}
                            <li class="friends-request-item d-flex flex-row justify-content-around">
                            <h5 class="align-self-center">{{ f_request.sender }}</h5>
                            <button class="btn btn-default btn-sm" value="{{ f_request.sender.pk }}"
                                    id="approveFriendRequest" onclick="response_to_friend_request(this, true)">approve</button>
                            <button class="btn btn-default btn-sm" value="{{ f_request.sender.pk }}"
                                    id="declineFriendRequest" onclick="response_to_friend_request(this, false)">decline</button>
                            </li>
                        {% endfor %}
                    {% endif %}
                    </ul>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Contacts Form  -->





{% endblock %}


