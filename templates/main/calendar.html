<!-- GroupCal/templates/main/calendar.html -->

{% extends 'base.html' %}
{% load get_dict_item %}
{% block script %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function get_calendar_height() {
                return $(window).height()-30;
            }
            let user_id = '{{ user.pk }}';
            let add_to_in_charge_msg = document.getElementById("success-alert");
            let current_event = null;
            let calendarEl = document.getElementById('calendar');
            let calendar = new FullCalendar.Calendar(calendarEl,  {
                plugins: ['interaction', 'dayGrid' ],
                editable: true,
                defaultView: 'dayGridMonth',
                selectable: true,
                height: get_calendar_height(),
                events: [
                    {% for i in events %}
                        {
                            id: '{{ i.id }}',
                            title: "{{ i.title}}",
                            description: "{{ i.description}}",
                            start: '{{ i.start}}',
                            end: '{{ i.end }}',
                            extendedProps: {
                                to_do: '{{ i.to_do }}',
                                charge_num: '{{ i.charge_num }}',
                                user_id: '{{ i.user_id }}',
                            },
                        },
                    {% endfor %}
                ],
                windowResize:  function(view) {
                    $('#calendar').fullCalendar('option', 'height', get_calendar_height());
                },

                dateClick: function(info) {
                    $('#createEventModal').modal('show');
                    $('#id_take_on_event').click(function () {
                        $("#id_charge_num").attr('disabled', !this.checked)
                    });
                    $('#eventForm').submit(function (e) {
                        console.log('jhgffghfhfg',info);
                        e.preventDefault();
                        let title=$('#id_title').val();
                        let description=$('#id_description').val();
                        let date = info.dateStr;
                        let to_do = $('#id_take_on_event').val();
                        let charge_num = $('#id_charge_num').val();
                        $.ajax({
                            type: 'POST',
                            url: '{%  url "events:event-create" %}',
                            data: {
                                title: title,
                                description: description,
                                start_hour: $('#id_start_hour').val(),
                                end_hour: $('#id_end_hour').val(),
                                date: date,
                                to_do: to_do,
                                charge_num: charge_num,
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                            },
                            success: function (response) {
                                $('#createEventModal').modal('hide');
                                let new_event = {
                                    id: response.instance_id,
                                    title: title,
                                    description: description,
                                    start: response.start_time,
                                    end: response.end_time,
                                    extendedProps: {
                                        to_do: to_do,
                                        charge_num: charge_num,
                                    },
                                };
                                calendar.addEvent(new_event);

                            },
                            error: function (rs, e) {
                                console.log(rs.responseText);
                            }
                        });
                    });
                },

                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    current_event = info;
                    console.log(current_event);

                    /*** fach the event data from the server and display the info according to the his type (to do or not to do)
                     * check if someone need to do the event:
                     *  info.event.extendedProps.to_do === 'False':
                     *  dont show the list of users that in charge to do the event
                     *
                     * info.event.extendedProps.to_do === 'True':
                     * send the event id to the server
                     * get the users list that in charge to do the event from the serer
                     * show the list in event window
                     *
                     ***/
                    if (info.event.extendedProps.to_do === 'False'){
                        clear_event_data();
                        update_event_window(info);
                    }
                    else{
                        $.ajax({
                            type: 'GET',
                            url: '{%  url "main:ajax_get_users_list" %}',
                            data: {
                                event_id: info.event.id,
                            },
                            success: function (json) {
                                /**event window is open so user can:
                                 * add them self to users in charge list
                                 * update the event (if they created it -- verify in update_event_window(info))
                                 *
                                 * **/
                                clear_event_data();
                                show_in_charge_users(json.users_list);
                                update_event_window(info);
                                document.getElementById("eventToDoBtn").addEventListener("click", function () {
                                    /** event is a to do event and user want to add himself to the list of user
                                     * that in charge -->> check with the server:
                                     * that the user is not in the list
                                     * the list is not full
                                     * the event is a to event (just in case)
                                     **/
                                    $.ajax({
                                        type: 'GET',
                                        url: '{%  url "main:ajax_user_to_charge_list" %}',
                                        data: {
                                            event_id: info.event.id,
                                        },
                                        success: function(data) {
                                            switch (data.check_user) {
                                                case 0:
                                                    let ul = document.getElementById("eventChargeUsers");
                                                    let li = document.createElement('li');
                                                    li.className ="list-group-item";
                                                    li.appendChild(document.createTextNode(data.name));
                                                    ul.appendChild(li);
                                                    break;
                                                case 1:
                                                    add_to_in_charge_msg.innerHTML = 'you already in this list';
                                                    add_to_in_charge_msg.style.display = 'block';
                                                    break;
                                                case 2:
                                                    add_to_in_charge_msg.innerHTML = 'this list is full';
                                                    add_to_in_charge_msg.style.display = 'block';
                                                    break;
                                            }
                                        },
                                        error : function(xhr,errmsg,err) {
                                            console.log(xhr.status + ": " + xhr.responseText);
                                        }
                                    });
                                });

                            },
                            error : function(xhr,errmsg,err) {
                                console.log(xhr.status + ": " + xhr.responseText);
                            }
                        });
                    }
                },
                eventDrop: function (info) {
                    {#if (info.event.start !== info.oldEvent.start || info.event.end !== info.oldEvent.end){#}
                    $.ajax({
                        type: 'GET',
                        url: '{%  url "events:ajax_event_change_date" %}',
                        data: {
                            event_id: info.event.id,
                            new_date_start: info.event.start.toISOString(),
                            new_date_end: info.event.end.toISOString(),
                        },
                        success: function(response) {
                            console.log(response)

                        },
                        error : function(xhr,errmsg,err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        },
                    });
                },
            });

            calendar.render();

            function update_event_window(info){
                document.getElementById("eventLabel").innerHTML = info.event.title;
                document.getElementById("eventDescription").innerHTML = info.event.extendedProps.description.toString();
                document.getElementById("eventStart").innerHTML = info.event.start;
                document.getElementById("eventEnd").innerHTML = info.event.end;
                document.getElementById("eventToDoBtn").disabled = info.event.extendedProps.to_do === "False";
                console.log(user_id);
                console.log(info.event.extendedProps.user_id);
                if(user_id === info.event.extendedProps.user_id){
                    document.getElementById('UpdateEventBtn').style.display ='inline';
                    document.getElementById('UpdateEventBtn').addEventListener("click", function () {
                        $('#eventDetails').modal('hide');
                        update_event_form(info);
                    });
                }
                else{
                    document.getElementById('UpdateEventBtn').style.display ='none';
                }
                $('#eventDetails').modal('show');
            }

            function show_in_charge_users(users_list) {
                $("#eventToDoBtn").disabled = false;
                let ul = document.getElementById("eventChargeUsers");
                for (let i = 0; i < users_list.length; i++){
                    let name = users_list[i];
                    let li = document.createElement('li');
                    li.className ="list-group-item";
                    li.appendChild(document.createTextNode(name));
                    ul.appendChild(li);
                }
            }

            function update_event_form(info){
                console.log(calendar.events());
                console.log(info);
                document.getElementById("id_title").value = info.event.title;
                document.getElementById("id_description").value = info.event.extendedProps.description.toString();
                document.getElementById("id_take_on_event").checked = info.event.extendedProps.to_do;
                document.getElementById("id_charge_num").value = info.event.extendedProps.charge_num;
                {#document.getElementById("id_start_hour").op = ;#}
                {#document.getElementById("id_end_hour").value = ;#}
                calendar.dateClick();
                $('#createEventModal').modal('show');
            }


            function clear_event_data() {
                document.getElementById("eventLabel").innerHTML = '';
                document.getElementById("eventDescription").innerHTML = '';
                document.getElementById("eventStart").innerHTML = '';
                document.getElementById("eventEnd").innerHTML = '';
                $('#eventChargeUsers').empty();
                add_to_in_charge_msg.innerHTML = '';
                add_to_in_charge_msg.style.display = 'none';
            }
        });
    </script>
{% endblock %}

{% block content %}
    <div class="container-fluid p-2">
        <div class="row ">
            <div class="col" id='calendar'></div>

            <div class="col-4 col-md-2 border">
                <div class="row pt-5">
                    <div class="col d-flex flex-column">
                        <div class="p-2">
                            <a class="btn btn-primary btn-block" data-toggle="collapse" href="#multiCollapseExample1" role="button" aria-expanded="false"
                               aria-controls="multiCollapseExample1">see users</a>
                        </div>
                        <div class="collapse multi-collapse" id="multiCollapseExample1">
                            <div class="list-group-flush card card-body">
                                {% for user in users_in_group %}
                                    <div class="list-group-item">
                                        <p class="mb-0"><i class="far fa-image fa-2x mr-4 grey p-3 white-text rounded-circle " aria-hidden="true"></i>{{ user.username }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row pt-5">
                    <div class="col d-flex flex-column">
                        <div class="p-2">
                            <button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#multiCollapseOptions"
                                    aria-expanded="false" aria-controls="multiCollapseOptions">options</button>
                        </div>
                        <div class="collapse multi-collapse p-2 text-center" id="multiCollapseOptions">
                            <button type="button" class="btn btn-secondary">Add Event</button>
                            <button type="button" class="btn btn-secondary">See your event</button>
                            <button type="button" class="btn btn-secondary">Add users</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Detail PopUp -->
    <div class="modal fade" id="eventDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-m " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100 font-weight-bold text-center" id="eventLabel"></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex flex-column" id="eventContent">
                    <p class="text-center" id="eventDescription"></p>
                    <span>start at:<p class="text-center" id="eventStart"></p></span>
                    <span>end at:<p class="text-center" id="eventEnd"></p></span>
                    <div class="alert alert-success" id="success-alert" style="display:none">
                        <button type="button" class="close" >x</button>
                        <span class="glyphicon glyphicon-ok"></span>
                    </div>
                    <ul class="list-group list-group-flush" id="eventChargeUsers" title="How is doing?">How is doing?</ul>
                </div>
                <div class="modal-footer justify-content-center">
                    <button id="eventToDoBtn" type="button" class="btn btn-blue-grey">Do it</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeEventWindow'">Close</button>
                    <button type="button" class="btn btn-primary" id="UpdateEventBtn">Update Event</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Create Event Form -->
    <div class="modal fade" id="createEventModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Add Event</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" id="eventForm" action="{% url "events:event-create" %}">
                    <div class="modal-body mx-3">
                        {% csrf_token %}
                        {{ eventForm.as_p }}
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="submit" id="submitButton" class="btn btn-unique">Save<i class="fas fa-paper-plane-o ml-1"></i></button>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
            </div>
        </div>
    </div>
{% endblock %}




